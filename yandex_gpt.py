import os
import aiohttp
import random
from typing import Optional, List

class YandexGPT:
    def __init__(self):
        self.facts_db = {
            "ri": {  # Российская Империя (базовый уровень)
                1721: {
                    "basic": "1721 год: Пётр I принял титул императора, Россия официально стала империей.",
                    "medium": "1721 год: После победы в Северной войне Пётр I принял титул императора. Это событие ознаменовало превращение России в империю. Сенат и Синод торжественно присвоили Петру титул «Отца Отечества, Императора Всероссийского, Петра Великого». Это изменение отражало новый статус России как одной из ведущих европейских держав.",
                    "advanced": "1721 год: Провозглашение России империей стало кульминацией петровских преобразований. После победы в Северной войне (1700-1721) Россия получила выход к Балтийскому морю и стала одной из сильнейших держав Европы. Пётр I получил титул императора, что уравняло его статус с другими европейскими монархами. Этому предшествовала масштабная реформаторская деятельность: создание регулярной армии и флота, реформа государственного управления, церковная реформа, развитие промышленности и торговли. Особое значение имело строительство Санкт-Петербурга (с 1703 года), который стал символом новой России. Империя распространила своё влияние от Балтики до Тихого океана, заложив основы для дальнейшей экспансии в XVIII-XIX веках."
                },
                1812: {
                    "basic": "1812 год: Отечественная война, Бородинское сражение.",
                    "medium": "1812 год: Вторжение армии Наполеона в Россию. Бородинское сражение стало крупнейшей битвой Отечественной войны. Французская армия численностью более 130 тысяч человек противостояла русской армии под командованием М.И. Кутузова. Сражение длилось 12 часов и привело к значительным потерям с обеих сторон.",
                    "advanced": "1812 год: Отечественная война стала поворотным моментом в истории России и Европы. Наполеоновская армия, численностью более 600 тысяч человек, вторглась в Россию 12 июня. Русская армия применила тактику отступления, изматывая противника. Бородинское сражение 7 сентября стало кульминацией войны: 130-тысячная французская армия против 120-тысячной русской. Битва длилась 12 часов, погибло около 100 тысяч человек. Хотя сражение не выявило явного победителя, оно подорвало боевой дух французской армии. Последовавшие решения Кутузова об оставлении Москвы и Тарутинский манёвр привели к катастрофическому отступлению армии Наполеона. Война способствовала росту национального самосознания и патриотизма, определила внешнеполитическое могущество России на десятилетия вперёд."
                },
                1825: {
                    "basic": "1825 год: Восстание декабристов на Сенатской площади.",
                    "medium": "1825 год: После смерти Александра I группа офицеров-единомышленников, впоследствии названных декабристами, организовала восстание на Сенатской площади в Санкт-Петербурге с целью предотвратить присягу новому императору Николаю I и добиться конституции.",
                    "advanced": "1825 год: Восстание декабристов 14 декабря стало первым организованным выступлением против самодержавия. Смерть Александра I и неясность в вопросе престолонаследия (из-за отречения Константина) создали ситуацию междуцарствия, которой решили воспользоваться тайные общества офицеров-реформаторов. Восставшие вывели около 3000 солдат на Сенатскую площадь, но не решились на активные действия. Николай I подавил восстание артиллерийским огнем. Пять руководителей (П. Пестель, К. Рылеев, С. Муравьёв-Апостол, М. Бестужев-Рюмин, П. Каховский) были казнены, более 100 человек отправлены на каторгу и в ссылку. Восстание оказало огромное влияние на общественное сознание и развитие освободительного движения в России XIX века. Александр Герцен назвал декабристов «первым поколением русских революционеров»."
                }
            },
            "ussr": {
                1941: {
                    "basic": "1941 год: Начало Великой Отечественной войны.",
                    "medium": "1941 год: 22 июня нацистская Германия вероломно напала на СССР. Началась Великая Отечественная война. В первые месяцы войны Красная Армия понесла тяжёлые потери и была вынуждена отступать. Однако героическая оборона Брестской крепости, Ленинграда, Киева и других городов замедлила продвижение врага.",
                    "advanced": "1941 год: Начало Великой Отечественной войны оказалось трагическим для СССР. 22 июня в 4 часа утра немецкие войска без объявления войны перешли границу СССР. План 'Барбаросса' предусматривал молниеносную войну и захват территории до линии Архангельск-Астрахань за 6-8 недель. Против СССР было брошено 190 дивизий (5,5 млн человек), 4300 танков, 47 тысяч орудий и миномётов, 4980 самолётов. В первые дни войны было уничтожено около 1200 советских самолётов. К концу года враг захватил Прибалтику, Белоруссию, Украину, блокировал Ленинград. Однако план блицкрига провалился благодаря героическому сопротивлению советского народа, эвакуации промышленности на восток (было перемещено более 1500 предприятий), мобилизации всех ресурсов страны. Битва за Москву в декабре 1941 года стала первым крупным поражением вермахта во Второй мировой войне."
                },
                1961: {
                    "basic": "1961 год: Первый полет человека в космос. Юрий Гагарин облетел Землю на космическом корабле «Восток».",
                    "medium": "1961 год: 12 апреля Юрий Гагарин совершил первый в истории человечества полет в космос на корабле «Восток-1». Полет длился 108 минут, за это время космический корабль совершил один оборот вокруг Земли. Это достижение подтвердило лидерство СССР в космической гонке с США.",
                    "advanced": "1961 год: Первый полет человека в космос стал триумфом советской науки и техники. 12 апреля в 9:07 с космодрома Байконур стартовал корабль «Восток-1» с Юрием Гагариным на борту. Полет длился 108 минут, корабль совершил один виток вокруг Земли на высоте от 181 до 327 км. При входе в атмосферу Гагарин катапультировался и приземлился отдельно от спускаемого аппарата, как и было предусмотрено конструкцией. Успех миссии стал результатом работы всей советской космической программы под руководством С.П. Королева. Этому событию предшествовали полеты собак Белки и Стрелки (1960), а также многочисленные испытания ракет-носителей и космических аппаратов. Полет Гагарина имел огромное международное значение, был воспринят как доказательство превосходства социалистической системы и стимулировал космическую гонку с США, которая привела к быстрому развитию космонавтики."
                }
            },
            "rf": {
                1991: {
                    "basic": "1991 год: Образование Российской Федерации.",
                    "medium": "1991 год: После событий августовского путча и подписания Беловежских соглашений СССР прекратил существование. Россия стала независимым государством, начался период радикальных экономических реформ под руководством Б.Н. Ельцина.",
                    "advanced": "1991 год: Образование Российской Федерации стало результатом сложных политических процессов конца 1980-х - начала 1990-х годов. После неудачной попытки государственного переворота ГКЧП 19-21 августа 1991 года, когда консервативная часть руководства СССР попыталась остановить процессы децентрализации, последовал запрет КПСС и ускорение распада Советского Союза. 8 декабря 1991 года в Беловежской пуще руководители России, Украины и Белоруссии подписали соглашения о прекращении существования СССР и создании СНГ. 25 декабря М.С. Горбачёв сложил полномочия президента СССР. Россия унаследовала международные обязательства СССР, место в Совете Безопасности ООН и ядерный арсенал. Начался период радикальных рыночных реформ, включавших либерализацию цен, приватизацию государственной собственности, что привело к глубоким социально-экономическим изменениям в обществе. Была принята Декларация о государственном суверенитете РСФСР, начала формироваться новая политическая система."
                }
            }
        }
        
        # Добавляем тематические факты
        self.thematic_facts = {
            "military": {
                "ri": [
                    {"year": 1812, "fact": "Отечественная война 1812 года - одна из крупнейших военных кампаний в истории России. Русская армия под командованием М.И. Кутузова применила тактику «выжженной земли» и отступления, что привело к истощению сил Наполеона и его последующему поражению."},
                    {"year": 1853, "fact": "Крымская война (1853-1856) стала серьезным испытанием для Российской империи. Несмотря на героическую оборону Севастополя, Россия потерпела поражение, что показало необходимость проведения военных реформ."}
                ],
                "ussr": [
                    {"year": 1941, "fact": "Великая Отечественная война стала самым масштабным военным конфликтом в истории СССР. На советско-германском фронте были разгромлены основные силы нацистской Германии."},
                    {"year": 1979, "fact": "Ввод советских войск в Афганистан в 1979 году привел к длительному военному конфликту, который длился почти 10 лет и завершился выводом советских войск в 1989 году."}
                ],
                "rf": [
                    {"year": 1994, "fact": "Первая чеченская война (1994-1996) стала первым крупным военным конфликтом современной России. Боевые действия завершились подписанием Хасавюртовских соглашений."},
                    {"year": 1999, "fact": "Вторая чеченская война началась в 1999 году после вторжения боевиков в Дагестан. В результате контртеррористической операции федеральные силы установили контроль над территорией Чечни."}
                ]
            },
            "culture": {
                "ri": [
                    {"year": 1825, "fact": "Первая треть XIX века считается «золотым веком» русской литературы. Творчество А.С. Пушкина, М.Ю. Лермонтова, Н.В. Гоголя заложило основы классической русской литературы."},
                    {"year": 1860, "fact": "В 1860-е годы расцвет переживала русская живопись. Товарищество передвижных художественных выставок, созданное в 1870 году, объединило художников-реалистов, таких как И. Репин, В. Суриков, И. Шишкин."}
                ],
                "ussr": [
                    {"year": 1932, "fact": "В 1932 году был создан Союз писателей СССР, что ознаменовало унификацию литературного процесса и утверждение социалистического реализма как официального художественного метода."},
                    {"year": 1957, "fact": "Период «оттепели» в советской культуре (1956-1964) характеризовался относительной либерализацией, появлением новых имен в литературе (А. Солженицын, В. Аксенов) и кино (М. Хуциев, А. Тарковский)."}
                ],
                "rf": [
                    {"year": 1991, "fact": "После распада СССР началась новая эпоха в российской культуре, характеризующаяся свободой творчества, отсутствием цензуры и интеграцией в мировое культурное пространство."},
                    {"year": 2000, "fact": "В начале 2000-х годов возросла государственная поддержка отечественного кинематографа, что привело к возрождению российского кино и появлению фильмов, имевших успех у зрителей."}
                ]
            },
            "politics": {
                "ri": [
                    {"year": 1861, "fact": "Отмена крепостного права в 1861 году императором Александром II стала важнейшей политической реформой XIX века. Она освободила крестьян от личной зависимости, но сохранила общинное землевладение."},
                    {"year": 1905, "fact": "Революция 1905-1907 годов привела к созданию первого представительного органа власти - Государственной думы и провозглашению гражданских свобод (Манифест 17 октября 1905 года)."}
                ],
                "ussr": [
                    {"year": 1922, "fact": "Образование СССР в 1922 году объединило РСФСР, Украинскую ССР, Белорусскую ССР и Закавказскую СФСР в единое государство с федеративным устройством."},
                    {"year": 1985, "fact": "Политика перестройки, объявленная М.С. Горбачевым в 1985 году, включала гласность, демократизацию и экономические реформы, что в конечном итоге привело к распаду СССР."}
                ],
                "rf": [
                    {"year": 1993, "fact": "В 1993 году был преодолен конституционный кризис (противостояние президента и парламента), и принята новая Конституция РФ, закрепившая президентскую республику."},
                    {"year": 2008, "fact": "Президентские выборы 2008 года привели к избранию Д.А. Медведева президентом, а В.В. Путин занял пост премьер-министра, что ознаменовало период «тандемократии»."}
                ]
            },
            "economy": {
                "ri": [
                    {"year": 1840, "fact": "В 1840-е годы в России началось активное железнодорожное строительство, что способствовало созданию единого экономического пространства и индустриализации страны."},
                    {"year": 1897, "fact": "Денежная реформа С.Ю. Витте 1897 года ввела золотой стандарт рубля, что укрепило финансовую систему и привлекло иностранные инвестиции."}
                ],
                "ussr": [
                    {"year": 1928, "fact": "Первый пятилетний план (1928-1932) положил начало форсированной индустриализации СССР, в результате которой были созданы новые отрасли промышленности."},
                    {"year": 1965, "fact": "Экономическая реформа А.Н. Косыгина 1965 года была направлена на усиление хозрасчета предприятий и материального стимулирования работников."}
                ],
                "rf": [
                    {"year": 1992, "fact": "Либерализация цен в январе 1992 года стала началом «шоковой терапии» и перехода к рыночной экономике, что привело к гиперинфляции и падению уровня жизни."},
                    {"year": 1998, "fact": "Дефолт 1998 года (отказ России выполнять обязательства по внутреннему долгу) привел к девальвации рубля, но создал условия для последующего экономического роста."}
                ]
            },
            "science": {
                "ri": [
                    {"year": 1755, "fact": "Основание Московского университета в 1755 году по инициативе М.В. Ломоносова стало важным событием в развитии науки и образования в России."},
                    {"year": 1869, "fact": "Д.И. Менделеев создал Периодическую систему химических элементов в 1869 году, что стало одним из величайших научных открытий XIX века."}
                ],
                "ussr": [
                    {"year": 1957, "fact": "Запуск первого искусственного спутника Земли в 1957 году открыл космическую эру и продемонстрировал научно-технический потенциал СССР."},
                    {"year": 1954, "fact": "В 1954 году в Обнинске была запущена первая в мире атомная электростанция, что положило начало мирному использованию атомной энергии."}
                ],
                "rf": [
                    {"year": 2006, "fact": "Российский математик Григорий Перельман доказал гипотезу Пуанкаре, одну из самых сложных математических задач тысячелетия."},
                    {"year": 2010, "fact": "В 2010 году в Дубне был синтезирован новый химический элемент с атомным номером 117, позднее названный теннессином."}
                ]
            },
            "daily_life": {
                "ri": [
                    {"year": 1861, "fact": "После отмены крепостного права в 1861 году началась активная миграция крестьян в города, что изменило социальную структуру российского общества."},
                    {"year": 1890, "fact": "В конце XIX века в крупных городах России появилось электрическое освещение и телефонная связь, что радикально изменило повседневную жизнь горожан."}
                ],
                "ussr": [
                    {"year": 1935, "fact": "1930-е годы ознаменовались массовым строительством метрополитена в Москве, что значительно улучшило транспортную систему столицы."},
                    {"year": 1957, "fact": "Массовое жилищное строительство в период «хрущевской оттепели» позволило миллионам советских граждан переехать из коммунальных квартир в отдельное жилье."}
                ],
                "rf": [
                    {"year": 1994, "fact": "В 1990-е годы произошла массовая компьютеризация и появление интернета в России, что революционизировало способы коммуникации и доступа к информации."},
                    {"year": 2000, "fact": "В начале 2000-х годов произошел бум мобильной связи - число абонентов выросло с нескольких миллионов до десятков миллионов, что изменило повседневную жизнь россиян."}
                ]
            }
        }

    async def generate_history_fact(self, epoch: str, year: Optional[int], difficulty: str, themes: Optional[List[str]] = None) -> str:
        """
        Генерирует исторический факт на основе параметров.
        
        Args:
            epoch: Историческая эпоха (ri, ussr, rf)
            year: Год (если None, выбирается случайный)
            difficulty: Уровень сложности (basic, medium, advanced)
            themes: Список выбранных тем (если None или пуст, выбирается из основной базы)
            
        Returns:
            str: Исторический факт
        """
        # Если указаны конкретные темы, выбираем факт из тематических коллекций
        if themes and len(themes) > 0:
            # Выбираем случайную тему из указанных
            theme = random.choice(themes)
            
            if theme in self.thematic_facts and epoch in self.thematic_facts[theme]:
                # Выбираем случайный факт из выбранной темы и эпохи
                fact_data = random.choice(self.thematic_facts[theme][epoch])
                
                # Если был указан конкретный год и он совпадает с годом факта, используем этот факт
                # Иначе просто используем выбранный случайный факт
                if year and fact_data["year"] == year:
                    return fact_data["fact"]
                elif not year:
                    return fact_data["fact"]
        
        # Если темы не указаны или подходящей темы не нашлось, используем основную базу фактов
        if epoch not in self.facts_db:
            return "Извините, для данной эпохи факты отсутствуют."

        if year and year in self.facts_db[epoch]:
            return self.facts_db[epoch][year][difficulty]

        # Если год не указан или для него нет факта, возвращаем случайный факт
        available_years = list(self.facts_db[epoch].keys())
        random_year = random.choice(available_years)
        return self.facts_db[epoch][random_year][difficulty]